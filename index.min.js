/**File locking functions. @preserve Copyright (c) 2021 Manuel LÃµhmus.*/
function lockFile(n,t,i=200){if(typeof t=="function")if(i=typeof i=="number"&&i>0?i:200,lockFiles[n])lockFiles[n]>5&&console.info("File '"+n+"' locked. Set timeout: "+i+"ms."),setTimeout(function(){lockFile(n,t,i)},i);else{lockFiles[n]=1;var r=setInterval(function(){lockFiles[n]++;lockFiles[n]>20&&(clearInterval(r),delete lockFiles[n],console.info("File locker problem. Timeout! File '"+n+"' now unlocked."))},i);t(null,function(){clearInterval(r);delete lockFiles[n]})}}function lockReadFile(n,t,i="utf8",r=200){lockFile(n,function(r,u){r?(fnRead(r),u()):fs.open(n,"r",function(n,r){function s(){typeof r=="number"?fs.close(r,function(){u()}):u()}if(n)s(),t(n);else{for(var f=Buffer.alloc(0),e=Buffer.alloc(1024),o=fs.readSync(r,e,0,1024,null);o>0;)f=Buffer.concat([f,e.subarray(0,o)]),o=fs.readSync(r,e,0,1024,null);s();t(null,f.toString(i))}})},r)}function lockWriteFile(n,t,i,r="utf8",u=200){t!==undefined&&t!==null&&lockFile(n,function(u,f){u?(f(),i(u)):fs.open(n,"w+",function(n,u){function o(){typeof u=="number"?fs.close(u,function(){f()}):f()}if(n)o(),i(n);else{fs.ftruncateSync(u,0);var e=Buffer.from(t,r),s=fs.writeSync(u,e,0,e.length,0);o();e.length!==s?i("Writing error!"):i()}})},u)}function lockReadWriteFile(n,t,i="utf8",r=200){lockFile(n,function(r,u){if(r)u(),t(r);else{var f=fs.existsSync(n)?"r+":"w+";fs.open(n,f,function(n,r){function s(){typeof r=="number"?fs.close(r,function(){u()}):u()}if(n)s(),t(n);else{for(var f=Buffer.alloc(0),e=Buffer.alloc(1024),o=fs.readSync(r,e,0,1024,null);o>0;)f=Buffer.concat([f,e.subarray(0,o)]),o=fs.readSync(r,e,0,1024,null);t(null,f.toString(i),function(n,t,f){if(typeof f!="function"&&(f=function(){}),n===null)u(),f();else{t&&fs.ftruncateSync(r,0);var e=Buffer.from(n+"",i),o=fs.writeSync(r,e,0,e.length,0);s();e.length!==o?f("Writing error!"):f()}})}})}},r)}function lockAppendFile(n,t,i,r="utf8",u=200){lockFile(n,function(u,f){if(u)f(),i(u);else{var e=fs.existsSync(n)?"a":"w+";fs.open(n,e,function(n,u){function e(){typeof u=="number"?fs.close(u,function(){f()}):f()}if(n)e(),i(n);else{var o=Buffer.from(t,r),s=fs.writeSync(u,o,0,null,null);e();o.length!==s?i("Writing error!"):i()}})}},u)}function lockDeleteFile(n,t,i=200){lockFile(n,function(i,r){i?(r(),t(i)):fs.existsSync(n)?fs.unlink(n,function(n){r();t(n)}):(r(),t("Error: Path '"+n+"' not exists."))},i)}function lockRename(n,t,i,r=200){lockFile(n,function(r,u){r?(u(),i(r)):fs.existsSync(n)?fs.rename(n,t,function(n){u();i(n)}):(u(),i("Error: Path '"+n+"' not exists."))},r)}function lockCreateDir(n,t,i=200){lockFile(n,function(i,r){i?(r(),t(i)):fs.existsSync(n)?(r(),t("Error: Path '"+n+"' exists.")):fs.mkdir(n,{recursive:!0,mode:504},function(n){r();t(n)})},i)}function lockDeleteDir(n,t,i=200){lockFile(n,function(i,r){i?(r(),t(i)):fs.existsSync(n)?fs.rmdir(n,{recursive:!0},function(n){r();t(n)}):(r(),t("Error: Path '"+n+"' not exists."))},i)}"use strict";var options=require("config-sets").init({file_lockdown:{ipc_port:8021,ipc_host:"localhost"}}).file_lockdown,fs=require("fs"),lockFiles={};var net_fn=require("net-fn"),fns=[lockReadFile,lockWriteFile,lockReadWriteFile,lockAppendFile,lockDeleteFile,lockRename,lockCreateDir,lockDeleteDir],fn_exports=net_fn.connect(fns,options.ipc_port,options.ipc_host);Object.keys(fn_exports).forEach(function(n){exports[n]=fn_exports[n]});net_fn.tryToRunServer(__filename,options.ipc_port,function(n){n?exports.worker=n:net_fn.createServer(fns,options.ipc_port,function(n){exports.server=n},options.ipc_host)},options.ipc_host);