/**File locking functions. @preserve Copyright (c) 2021 Manuel Lï¿½hmus.*/
function lockFile(n,t,i=200){if(typeof t=="function")if(i=typeof i=="number"&&i>0?i:200,lockFiles[n])setImmediate(function(){lockFile(n,t,i)});else{lockFiles[n]=1;var r=setInterval(function(){lockFiles[n]++;lockFiles[n]>20&&(clearInterval(r),delete lockFiles[n],console.info("[ INFO ] 'file-lockdown' File locker problem. Timeout! File '"+n+"' now unlocked."))},i);t(null,function(){clearInterval(r);delete lockFiles[n]})}}function lockReadFile(n,t,i="utf8",r){lockFile(n,function(r,u){r?(fnRead(r),u()):fs.open(n,"r",function(n,r){function f(){typeof r=="number"?fs.close(r,function(){u()}):u()}if(n)f(),t(n);else{function n(u,s,h){u?(f(),t(u)):(o+=h.toString(i,0,s),h[h.byteLength-1]!==0?(e+=s,fs.read(r,{position:e},n)):(f(),t(null,o)))}var o="",e=0;fs.read(r,{position:e},n)}})},r)}function lockWriteFile(n,t,i,r="utf8",u){t!==undefined&&t!==null?lockFile(n,function(u,f){u?(f(),i(u)):fs.open(n,"w+",function(n,u){function e(){typeof u=="number"?fs.close(u,function(){f()}):f()}function o(n){n?(e(),i(n)):fs.write(u,t,0,r,function(n){e();i(n)})}n?(e(),i(n)):fs.ftruncate(u,0,o)})},u):i(new Error("Wrong buffer value."))}function lockReadWriteFile(n,t,i="utf8",r){lockFile(n,function(r,u){r?(u(),t(r)):fs.access(n,fs.constants.F_OK,function(r){var f=r?"w+":"r+";fs.open(n,f,function(n,r){function f(){typeof r=="number"?fs.close(r,function(){u()}):u()}function s(n,t,e){function o(t){t?(f(),e(t)):typeof n=="string"?fs.write(r,n,0,i,function(n){f();e(n)}):f()}typeof e!="function"&&(e=function(){});n===null?(u(),e()):t?fs.ftruncate(r,0,o):o()}if(n)f(),t(n);else{function n(u,h,c){u?(f(),t(u)):(o+=c.toString(i,0,h),c[c.byteLength-1]!==0?(e+=h,fs.read(r,{position:e},n)):t(null,o,s))}var o="",e=0;fs.read(r,{position:e},n)}})})},r)}function lockAppendFile(n,t,i,r="utf8",u){t!==undefined&&t!==null?lockFile(n,function(u,f){u?(f(),i(u)):fs.access(n,fs.constants.F_OK,function(u){var e=u?"w+":"a";fs.open(n,e,function(n,u){function e(){typeof u=="number"?fs.close(u,function(){f()}):f()}if(n)e(),i(n);else{var o=Buffer.from(t,r);fs.write(u,o,0,null,null,function(n){e();i(n)})}})})},u):i(new Error("Wrong buffer value."))}function lockDeleteFile(n,t,i){lockFile(n,function(i,r){i?(r(),t(i)):fs.rm(n,function(n){r();t(n)})},i)}function lockRename(n,t,i,r){lockFile(n,function(r,u){r?(u(),i(r)):fs.rename(n,t,function(n){u();i(n)})},r)}function lockCreateDir(n,t,i){lockFile(n,function(i,r){i?(r(),t(i)):fs.mkdir(n,{recursive:!0,mode:504},function(n){r();t(n)})},i)}function lockDeleteDir(n,t,i){lockFile(n,function(i,r){i?(r(),t(i)):fs.rm(n,{recursive:!0},function(n){r();t(n)})},i)}function lockAccess(n,t,i){lockFiles[n]&&t();lockFile(n,function(i,r){i&&(r(),t(i));fs.access(n,fs.constants.F_OK,function(n){r();t(n)})},i)}var confSet,options;confSet=require("config-sets");options=confSet.init({file_lockdown:{ipc_port:8021,ipc_host:"localhost"}}).file_lockdown;exports.options=options;var isDebug=Boolean(confSet&&confSet.isDebug),fs=require("node:fs"),lockFiles={};exports.directly={lockReadFile,lockWriteFile,lockReadWriteFile,lockAppendFile,lockDeleteFile,lockRename,lockCreateDir,lockDeleteDir,lockAccess};var net_fn=require("net-fn"),fns=[lockReadFile,lockWriteFile,lockReadWriteFile,lockAppendFile,lockDeleteFile,lockRename,lockCreateDir,lockDeleteDir,lockAccess],fn_exports=net_fn.connect(fns,options.ipc_port,options.ipc_host);Object.keys(fn_exports).forEach(function(n){exports[n]=fn_exports[n]});isDebug&&console.log("`[ DEBUG ] 'file-lockdown' Starting worker!");net_fn.tryToRunServer(__filename,options.ipc_port,function(n){n?exports.worker=n:(isDebug&&console.log("`[ DEBUG ] 'file-lockdown' Starting server!"),net_fn.createServer(fns,options.ipc_port,function(n){exports.server=n},options.ipc_host))},options.ipc_host);